<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ICLand simulation visualisation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        html, body {
            height: 100vh;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        body {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        h1 {
            margin: 0 0 20px 0;
        }
        #main-container {
            flex: 1;
            display: flex;
            gap: 20px;
        }
        #numeric-container {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
        }
        #image-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #image-display {
            flex: 0 0 auto;
            text-align: center;
        }
        #timestep-slider {
            width: 100%;
            margin-top: 10px;
        }
        #control-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        #stop-button, #play-button {
            padding: 10px 20px;
            color: white;
            border: none;
            cursor: pointer;
        }
        #stop-button {
            background-color: #ff4444;
        }
        #stop-button:hover {
            background-color: #cc0000;
        }
        #play-button {
            background-color: #44ff44;
        }
        #play-button:hover {
            background-color: #00cc00;
        }
        #play-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #current-timestep {
            margin-top: 10px;
        }
        .agent-data {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f4f4f4;
        }
        img {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            width: 100%; /* Ensure placeholder fills container */
            height: auto;
            object-fit: cover; /* Maintain aspect ratio while filling */
        }
    </style>
</head>
<body>
    <h1>ICLand simulation visualisation</h1>
    <div id="main-container">
        <div id="numeric-container"></div>
        <div id="image-container">
            <div id="image-display"></div>
            <input type="range" id="timestep-slider" min="0" max="0" value="0" disabled>
            <div id="control-buttons">
                <button id="play-button" disabled>Play</button>
                <button id="stop-button">Stop Server</button>
            </div>
            <div id="current-timestep">Timestep: 0</div>
        </div>
    </div>

    <script>
        const socket = io('http://localhost:5000');
        let simulationData = [];
        let currentTimestep = 0;
        let simulationEnded = false;
        let lastImageSrc = null;
        let playInterval = null;

        socket.on('connect', function() {
            console.log('Connected to server');
            socket.emit('get_simulation_data');
        });

        socket.on('simulation_data_update', function(data) {
            simulationData.push(data);
            if (!simulationEnded) {
                currentTimestep = data.timestep;
                updateSlider();
                updateDisplay(data);
                const numericContainer = document.getElementById('numeric-container');
                numericContainer.scrollTop = numericContainer.scrollHeight;
            } else {
                updateSlider();
            }
        });

        socket.on('simulation_ended', function() {
            simulationEnded = true;
            document.getElementById('timestep-slider').disabled = false;
            document.getElementById('play-button').disabled = false; // Enable play button when simulation ends
        });

        socket.on('simulation_data_response', function(data) {
            if (Array.isArray(data)) {
                simulationData = data;
                if (data.length > 0 && !simulationEnded) {
                    currentTimestep = data[data.length - 1].timestep;
                }
                updateSlider();
                updateDisplay(simulationData[simulationData.length - 1]);
                if (!simulationEnded) {
                    const numericContainer = document.getElementById('numeric-container');
                    numericContainer.scrollTop = numericContainer.scrollHeight;
                }
            } else {
                updateDisplay(data);
            }
        });

        socket.on('server_stopped', function() {
            console.log('Server has stopped');
            alert('The server has been terminated.');
            stopPlayback();
        });

        function updateSlider() {
            const slider = document.getElementById('timestep-slider');
            slider.max = simulationData.length - 1;
            if (!simulationEnded) {
                slider.value = simulationData.length - 1;
            } else {
                slider.value = simulationData.findIndex(d => d.timestep === currentTimestep);
            }
            document.getElementById('current-timestep').textContent = `Timestep: ${currentTimestep}`;
        }

        function updateDisplay(data) {
            const numericContainer = document.getElementById('numeric-container');
            const imageDisplay = document.getElementById('image-display');
            
            // Update numeric data on the left
            numericContainer.innerHTML = '';
            if (data) {
                const timestepDiv = document.createElement('div');
                timestepDiv.innerHTML = `<h3>Timestep: ${data.timestep}</h3>`;

                data.positions.forEach((pos, index) => {
                    const agentDiv = document.createElement('div');
                    agentDiv.className = 'agent-data';
                    agentDiv.innerHTML = `
                        <h4>Agent ${index}</h4>
                        <p>Position: [${pos}]</p>
                        <p>Reward: ${data.rewards[index]}</p>
                    `;
                    timestepDiv.appendChild(agentDiv);
                });

                numericContainer.appendChild(timestepDiv);
            }

            // Update image on the right with placeholder
            imageDisplay.innerHTML = '';
            if (data) {
                const img = document.createElement('img');
                const newSrc = `data:image/png;base64,${data.image}`;
                
                // Use placeholder initially
                img.src = '/static/placeholder.png'; // Placeholder while loading
                
                // If there's a previous image and it's not the first load, use it instead of placeholder
                if (lastImageSrc && simulationData.length > 1) {
                    img.src = lastImageSrc;
                }

                // Load the new image in the background
                const tempImg = new Image();
                tempImg.src = newSrc;
                tempImg.onload = function() {
                    img.src = newSrc;
                    lastImageSrc = newSrc;
                };
                tempImg.onerror = function() {
                    console.error(`Failed to load image for timestep ${data.timestep}`);
                    img.alt = 'Image failed to load';
                    img.src = '/static/placeholder.png'; // Revert to placeholder on error
                };

                imageDisplay.appendChild(img);
            }
        }

        document.getElementById('timestep-slider').addEventListener('input', function() {
            stopPlayback();
            const index = parseInt(this.value);
            currentTimestep = simulationData[index].timestep;
            document.getElementById('current-timestep').textContent = `Timestep: ${currentTimestep}`;
            updateDisplay(simulationData[index]);
        });

        document.getElementById('stop-button').addEventListener('click', function() {
            if (confirm('Are you sure you want to stop the server? This will terminate the simulation.')) {
                socket.emit('stop_server');
            }
        });

        document.getElementById('play-button').addEventListener('click', function() {
            if (playInterval) {
                stopPlayback();
            } else {
                startPlayback();
            }
        });

        function startPlayback() {
            if (simulationData.length === 0) return;
            document.getElementById('play-button').textContent = 'Pause';
            document.getElementById('timestep-slider').disabled = true;
            playInterval = setInterval(() => {
                const currentIndex = simulationData.findIndex(d => d.timestep === currentTimestep);
                const nextIndex = (currentIndex + 1) % simulationData.length;
                currentTimestep = simulationData[nextIndex].timestep;
                updateSlider();
                updateDisplay(simulationData[nextIndex]);
            }, 100);
        }

        function stopPlayback() {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
                document.getElementById('play-button').textContent = 'Play';
                document.getElementById('timestep-slider').disabled = simulationEnded;
            }
        }

        socket.emit('get_simulation_data');
    </script>
</body>
</html>